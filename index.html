<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STICK SCRIPT v9.0 (Emoji Engine)</title>
    <!-- 1. IMPORT LIBRARIES -->
    <!-- Anime.js for smooth movement (Keep this, it's lightweight and great) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
            background-color: #222;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        header {
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            font-size: 3rem;
            margin: 0;
            letter-spacing: 5px;
            color: #FFD700; /* Gold */
            text-shadow: 0 0 10px #FFD700;
        }

        .subtitle {
            color: #aaa;
            font-size: 1.2rem;
            font-family: 'Courier New', Courier, monospace;
        }

        #config-section {
            margin-bottom: 20px;
            width: 800px;
            display: flex;
            justify-content: flex-end;
        }

        input[type="password"] {
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            width: 250px;
        }

        #mission-panel {
            width: 800px;
            background: #fff;
            color: #000;
            padding: 20px;
            box-sizing: border-box;
            border: 2px solid #999;
            border-left: 10px solid #FFD700;
            margin-bottom: 15px;
            font-family: 'Courier New', Courier, monospace;
            position: relative;
            transform: rotate(-1deg);
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
        }

        #mission-title { font-weight: bold; font-size: 1.5rem; margin-bottom: 10px; text-decoration: underline; }
        #mission-brief { font-size: 1.1rem; line-height: 1.4; }
        #mission-hint { margin-top: 10px; font-style: italic; color: #555; font-size: 0.9rem; }

        #stage-container {
            position: relative;
            width: 800px;
            height: 600px;
            border: 4px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: #87CEEB; /* Sky Blue */
            overflow: hidden;
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }

        /* Feedback Overlay */
        #feedback-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8); color: white; text-align: center;
            font-family: 'Courier New', Courier, monospace;
        }

        #feedback-title { font-size: 4rem; font-weight: bold; margin-bottom: 20px; transform: rotate(-5deg); }
        .success-text { color: #0f0; text-shadow: 0 0 20px #0f0; border: 5px solid #0f0; padding: 20px; }
        .fail-text { color: #f00; text-shadow: 0 0 20px #f00; border: 5px solid #f00; padding: 20px; }

        #next-level-btn {
            margin-top: 20px; padding: 15px 30px; background: #fff; color: black;
            font-size: 1.5rem; border: none; cursor: pointer; font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
        }

        #controls {
            margin-top: 20px; width: 800px; display: flex; flex-direction: column; gap: 10px;
        }

        textarea {
            width: 100%; height: 80px; padding: 15px; background: #333;
            border: 1px solid #555; color: white; border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            box-sizing: border-box; resize: none; font-size: 1.1rem;
        }

        button {
            padding: 15px; background-color: #FFD700; color: black;
            border: none; border-radius: 4px; font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: all 0.2s;
        }
        button:hover { background-color: #FFC000; box-shadow: 0 0 15px #FFD700; }
        button:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; color: white; }
    </style>
</head>
<body>

    <header>
        <h1>STICK SCRIPT</h1>
        <div class="subtitle">v9.0: EMOJI ENGINE</div>
    </header>

    <div id="config-section">
        <input type="password" id="apiKey" placeholder="Enter OpenAI API Key">
    </div>

    <div id="mission-panel">
        <div id="mission-title">SCENE 1</div>
        <div id="mission-brief">Loading...</div>
        <div id="mission-hint"></div>
    </div>

    <div id="stage-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="feedback-overlay">
            <div id="feedback-title">CUT!</div>
            <div id="feedback-msg">Print it!</div>
            <button id="next-level-btn">NEXT SCENE >></button>
        </div>
    </div>

    <div id="controls">
        <textarea id="storyInput" placeholder="Write your script here..."></textarea>
        <button id="actionBtn">ACTION!</button>
    </div>

    <script>
        // === DOM ELEMENTS ===
        const apiKeyInput = document.getElementById('apiKey');
        const storyInput = document.getElementById('storyInput');
        const actionBtn = document.getElementById('actionBtn');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const missionTitle = document.getElementById('mission-title');
        const missionBrief = document.getElementById('mission-brief');
        const missionHint = document.getElementById('mission-hint');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackTitle = document.getElementById('feedback-title');
        const nextLevelBtn = document.getElementById('next-level-btn');
        
        // === LEVELS ===
        const LEVELS = [
            {
                id: 1,
                title: "SCENE 1: THE GETAWAY",
                brief: "EXECUTIVE ORDER: Our hero just robbed a bank. He needs to escape! We need a vehicle.",
                hint: "TIP: Ask for a Car, Bike, or Motorcycle.",
                required_keywords: ["car", "motorcycle", "bike", "bicycle", "vehicle", "van", "truck", "ride", "drive"],
                bg_sky: "#87CEEB", bg_ground: "#3CB371" // Sunny Day
            },
            {
                id: 2,
                title: "SCENE 2: THE DUEL",
                brief: "EXECUTIVE ORDER: A samurai stands in the way. Our hero needs a weapon.",
                hint: "TIP: He needs a 'Sword' or 'Katana'.",
                required_keywords: ["sword", "katana", "blade", "weapon", "knife"],
                bg_sky: "#FFD700", bg_ground: "#8B4513" // Sunset / Dojo
            },
            {
                id: 3,
                title: "SCENE 3: NATURE'S WRATH",
                brief: "EXECUTIVE ORDER: Make it rain. Make it storm.",
                hint: "TIP: Mention 'Rain', 'Storm', or 'Thunder'.",
                required_keywords: ["rain", "storm", "wet", "umbrella", "thunder"],
                bg_sky: "#444444", bg_ground: "#2F4F4F" // Stormy Dark
            },
            {
                id: 4,
                title: "SCENE 4: ALIEN INVASION",
                brief: "EXECUTIVE ORDER: We need a sci-fi twist. Bring in the extraterrestrials.",
                hint: "TIP: Aliens or UFOs.",
                required_keywords: ["alien", "ufo", "saucer", "spaceship", "martian"],
                bg_sky: "#000000", bg_ground: "#808080" // Space / Moon
            }
        ];

        let currentLevelIndex = 0;
        let currentEntities = [];
        let animationLoopId = null;

        // === INITIALIZATION ===
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('stick_script_api_key');
            if (savedKey) apiKeyInput.value = savedKey;
            loadLevel(0);
        });

        apiKeyInput.addEventListener('change', (e) => localStorage.setItem('stick_script_api_key', e.target.value));
        actionBtn.addEventListener('click', handleAction);
        nextLevelBtn.addEventListener('click', nextLevel);

        function loadLevel(index) {
            // HARD RESET
            if (animationLoopId) cancelAnimationFrame(animationLoopId);
            anime.remove(currentEntities);
            currentEntities = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear Canvas immediately

            currentLevelIndex = index;
            const level = LEVELS[index];
            if (!level) {
                missionTitle.textContent = "WRAPPED!";
                missionBrief.textContent = "That's a wrap on production! Great work, Director.";
                missionHint.textContent = "";
                actionBtn.disabled = true;
                return;
            }
            missionTitle.textContent = level.title;
            missionBrief.textContent = level.brief;
            missionHint.textContent = level.hint;
            storyInput.value = "";
            feedbackOverlay.style.display = "none";
            drawPlaceholder();
        }

        function nextLevel() { loadLevel(currentLevelIndex + 1); }

        function showFeedback(success) {
            feedbackOverlay.style.display = "flex";
            if (success) {
                feedbackTitle.className = "success-text";
                feedbackTitle.textContent = "CUT! PRINT IT!";
                nextLevelBtn.style.display = "block";
            } else {
                feedbackTitle.className = "fail-text";
                feedbackTitle.textContent = "RESBOOT!";
                nextLevelBtn.style.display = "none";
                setTimeout(() => feedbackOverlay.style.display = "none", 3000);
            }
        }

        function drawPlaceholder() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const level = LEVELS[currentLevelIndex] || LEVELS[0];
            
            // Draw Sky
            ctx.fillStyle = level.bg_sky || '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw Ground
            ctx.fillStyle = level.bg_ground || '#3CB371';
            ctx.fillRect(0, 500, 800, 100);

            ctx.fillStyle = (level.bg_sky === '#000000' || level.bg_sky === '#444444') ? '#fff' : '#333';
            ctx.font = '20px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText('Waiting for Director...', canvas.width/2, canvas.height/2);
        }

        // === ENGINE LOGIC ===
        async function handleAction() {
            const prompt = storyInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey || !prompt) { alert("Missing API Key or Prompt."); return; }

            if (animationLoopId) cancelAnimationFrame(animationLoopId);
            anime.remove(currentEntities); 
            
            actionBtn.disabled = true;
            actionBtn.textContent = "CASTING...";

            const level = LEVELS[currentLevelIndex];
            
            // FAST EMOJI PROMPT
            const SYSTEM_PROMPT = `You are a Casting Director.
MISSION OBJECTIVES: Include: [${level.required_keywords.join(", ")}].

1. Analyze prompt: "${prompt}".
2. Does it satisfy the mission?
3. Assign an EMOJI to each actor/prop.

OUTPUT JSON:
{
  "mission_satisfied": true,
  "entities": [
    { 
      "name": "hero", 
      "emoji": "ðŸƒ", 
      "startX": 100, "startY": 450, "endX": 600, "endY": 450, 
      "scale": 1.0, "action": "run" 
    },
    {
      "name": "car",
      "emoji": "ðŸš—",
      "startX": 300, "startY": 470, "endX": 300, "endY": 470,
      "scale": 1.5, "action": "static"
    }
  ]
}
CONSTRAINTS:
- Use standard unicode emojis.
- Ground level y=500.
- Scale 1.0 is normal size (approx 100px).
`;

            try {
                // Low tokens = FAST response
                const jsonStr = await callAI(SYSTEM_PROMPT, prompt, apiKey, 300);
                const sceneData = JSON.parse(jsonStr.replace(/```json/g, '').replace(/```/g, '').trim());
                
                startScene(sceneData);

                const isSuccess = sceneData.mission_satisfied;

                setTimeout(() => {
                    showFeedback(isSuccess);
                    actionBtn.disabled = false;
                    actionBtn.textContent = "ACTION!";
                }, 1500); // Quick check
            } catch (error) {
                console.error(error);
                alert("Director Error: " + error.message);
                drawPlaceholder();
                actionBtn.disabled = false;
                actionBtn.textContent = "ACTION!";
            }
        }

        async function callAI(system, user, key, maxTokens) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [{ role: "system", content: system }, { role: "user", content: user }],
                    temperature: 0.7,
                    max_tokens: maxTokens
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.choices[0].message.content;
        }

        function startScene(data) {
            currentEntities = data.entities.map(e => ({
                ...e,
                x: e.startX || 0, y: e.startY || 450,
                prevX: e.startX || 0,
                rotation: 0
            }));

            // Setup Movement
            currentEntities.forEach(entity => {
                if (entity.endX !== undefined && entity.endY !== undefined) {
                    if (entity.endX !== entity.startX || entity.endY !== entity.startY) {
                        anime({ 
                            targets: entity, 
                            x: entity.endX, 
                            y: entity.endY, 
                            duration: 3000, 
                            easing: 'easeInOutQuad', 
                            loop: true, 
                            direction: 'alternate' 
                        });
                        
                        // Add a little bounce to runners
                        if (entity.action === "run" || entity.action === "walk") {
                            anime({
                                targets: entity,
                                y: entity.startY - 20,
                                duration: 300,
                                easing: 'easeOutQuad',
                                loop: true,
                                direction: 'alternate'
                            });
                        }
                    }
                }
            });
            renderLoop();
        }

        function renderLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const level = LEVELS[currentLevelIndex] || LEVELS[0];

            // Draw Sky
            ctx.fillStyle = level.bg_sky || '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw Ground
            ctx.fillStyle = level.bg_ground || '#3CB371'; 
            ctx.fillRect(0, 500, 800, 100);

            // Draw Entities
            currentEntities.forEach(entity => {
                ctx.save();
                ctx.translate(entity.x, entity.y);
                
                // FLIP LOGIC
                const dx = entity.x - entity.prevX;
                if (dx < -0.1) {
                    ctx.scale(-1, 1); // Face left
                }
                
                // Draw Emoji Centered
                ctx.font = `${100 * (entity.scale || 1)}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(entity.emoji, 0, 0);
                
                ctx.restore();
                
                // Update prev position
                entity.prevX = entity.x;
            });

            animationLoopId = requestAnimationFrame(renderLoop);
        }
    </script>
</body>
</html>
