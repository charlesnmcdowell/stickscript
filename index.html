<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STICK SCRIPT v5.2 (8-Bit Edition)</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #222;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        header {
            margin-bottom: 20px;
        }

        h1 {
            font-size: 3rem;
            margin: 0;
            letter-spacing: 5px;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
        }

        #config-section {
            margin-bottom: 20px;
            width: 800px;
            display: flex;
            justify-content: flex-end;
        }

        input[type="password"] {
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            font-family: inherit;
            width: 250px;
        }

        #stage {
            border: 4px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #controls {
            margin-top: 20px;
            width: 800px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 15px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
            resize: none;
            font-size: 1.1rem;
        }

        button {
            padding: 15px;
            background-color: #0f0;
            color: black;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background-color: #0a0;
            box-shadow: 0 0 15px #0f0;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body>

    <header>
        <h1>STICK SCRIPT v5.2</h1>
    </header>

    <div id="config-section">
        <input type="password" id="apiKey" placeholder="Enter OpenAI API Key">
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="controls">
        <textarea id="storyInput" placeholder="Describe the scene... (e.g., A ninja jumping over a car)"></textarea>
        <button id="actionBtn">ACTION!</button>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKey');
        const storyInput = document.getElementById('storyInput');
        const actionBtn = document.getElementById('actionBtn');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false; // Pixel art mode

        // === PIXEL ART GENERATOR (Procedural 8-bit) ===
        function createCharacterSprite(shirtColor) {
            const w = 24, h = 48; // Upscaled pixels
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            const cx = c.getContext('2d');
            
            // Skin
            cx.fillStyle = '#ffccaa';
            cx.fillRect(6, 0, 12, 12); // Head
            cx.fillRect(2, 14, 4, 10); // L Arm
            cx.fillRect(18, 14, 4, 10); // R Arm

            // Shirt
            cx.fillStyle = shirtColor;
            cx.fillRect(6, 12, 12, 16); 

            // Pants
            cx.fillStyle = '#223388';
            cx.fillRect(6, 28, 5, 16); // L Leg
            cx.fillRect(13, 28, 5, 16); // R Leg

            // Eyes
            cx.fillStyle = 'black';
            cx.fillRect(8, 4, 2, 2);
            cx.fillRect(14, 4, 2, 2);

            return c;
        }

        function createNinjaSprite() {
            const w = 24, h = 48;
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            const cx = c.getContext('2d');
            
            // Suit (Black)
            cx.fillStyle = '#111';
            cx.fillRect(6, 0, 12, 12); // Head
            cx.fillRect(6, 12, 12, 16); // Body
            cx.fillRect(6, 28, 5, 16); // L Leg
            cx.fillRect(13, 28, 5, 16); // R Leg
            cx.fillRect(2, 14, 4, 10); // Arms
            cx.fillRect(18, 14, 4, 10);

            // Sash
            cx.fillStyle = 'red';
            cx.fillRect(6, 20, 12, 4);
            cx.fillRect(16, 20, 4, 10); // Dangling bit

            // Eyes (White slit)
            cx.fillStyle = 'white';
            cx.fillRect(8, 4, 8, 2);

            return c;
        }

        function createDogSprite() {
            const w = 40, h = 24;
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            const cx = c.getContext('2d');

            cx.fillStyle = '#8B4513';
            cx.fillRect(10, 8, 20, 10); // Body
            cx.fillRect(0, 0, 12, 12); // Head
            cx.fillRect(10, 18, 4, 6); // F Leg
            cx.fillRect(26, 18, 4, 6); // B Leg
            cx.fillRect(30, 8, 8, 4); // Tail

            cx.fillStyle = 'black';
            cx.fillRect(0, 4, 4, 4); // Nose
            cx.fillRect(6, 2, 2, 2); // Eye

            return c;
        }

        function createPropSprite(type, color) {
            const w = 60, h = 60;
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            const cx = c.getContext('2d');
            cx.fillStyle = color;

            if (type === 'car') {
                cx.fillRect(0, 20, 60, 20); // Body
                cx.fillRect(10, 5, 40, 15); // Top
                cx.fillStyle = 'black';
                cx.beginPath(); cx.arc(15, 40, 8, 0, Math.PI*2); cx.fill(); // Wheel 1
                cx.beginPath(); cx.arc(45, 40, 8, 0, Math.PI*2); cx.fill(); // Wheel 2
            } else if (type === 'tree') {
                cx.fillStyle = '#8B4513';
                cx.fillRect(25, 30, 10, 30); // Trunk
                cx.fillStyle = 'forestgreen';
                cx.beginPath(); cx.arc(30, 20, 25, 0, Math.PI*2); cx.fill(); // Leaves
            } else if (type === 'ball') {
                cx.beginPath(); cx.arc(30, 30, 10, 0, Math.PI*2); cx.fill();
            }

            return c;
        }

        // === ASSET LIBRARY ===
        const ASSETS = {
            man: { sprite: createCharacterSprite('cyan'), width: 24, height: 48, type: 'char' },
            ninja: { sprite: createNinjaSprite(), width: 24, height: 48, type: 'char' },
            dog: { sprite: createDogSprite(), width: 40, height: 24, type: 'char' },
            car: { sprite: createPropSprite('car', 'red'), width: 60, height: 50, type: 'prop' },
            tree: { sprite: createPropSprite('tree', ''), width: 60, height: 60, type: 'prop' },
            ball: { sprite: createPropSprite('ball', 'yellow'), width: 60, height: 60, type: 'prop' }
        };

        // === SCENE STATE ===
        let currentScene = {
            background: 'sky',
            entities: [] 
        };
        let animationId = null;

        // === PROMPTS ===
        const SYSTEM_PROMPT = `You are a Scene Director.
You will receive a story description.
You must output a JSON object describing the initial state of the scene.

AVAILABLE ASSETS:
- Characters: man, ninja, dog
- Props: car, tree, ball

OUTPUT FORMAT (JSON ONLY):
{
  "background": "park" (or "city", "desert"),
  "entities": [
    { 
      "type": "ninja", 
      "x": 100, 
      "y": 400, 
      "action": "run_right" (sets velocity)
    }
  ]
}

LOGIC RULES:
- x=0 is left, x=800 is right.
- Ground level is y=500.
- If action is "run_right", implied dx=5.
- If action is "jump", implied dy=-10.
- Do not output markdown. Just JSON.`;

        // === INITIALIZATION ===
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('stick_script_api_key');
            if (savedKey) apiKeyInput.value = savedKey;
            drawPlaceholder();
        });

        apiKeyInput.addEventListener('change', (e) => {
            localStorage.setItem('stick_script_api_key', e.target.value);
        });

        actionBtn.addEventListener('click', handleAction);

        function drawPlaceholder() {
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#444';
            ctx.font = '20px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText('Awaiting Director Input...', canvas.width/2, canvas.height/2);
        }

        async function handleAction() {
            const prompt = storyInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey || !prompt) {
                alert("Missing API Key or Prompt.");
                return;
            }

            if (animationId) cancelAnimationFrame(animationId);

            actionBtn.disabled = true;
            actionBtn.textContent = "DIRECTING...";
            
            try {
                const jsonStr = await callAI(SYSTEM_PROMPT, prompt, apiKey);
                const sceneData = JSON.parse(jsonStr.replace(/```json/g, '').replace(/```/g, '').trim());
                
                initScene(sceneData);
                loop();
            } catch (error) {
                console.error(error);
                alert("Cut! " + error.message);
                drawPlaceholder();
            } finally {
                actionBtn.disabled = false;
                actionBtn.textContent = "ACTION!";
            }
        }

        async function callAI(system, user, key) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        { role: "system", content: system },
                        { role: "user", content: user }
                    ],
                    temperature: 0.5
                })
            });
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // === ENGINE LOGIC ===
        function initScene(data) {
            currentScene.background = data.background || 'sky';
            currentScene.entities = data.entities.map(e => {
                let dx = 0;
                let dy = 0;
                if (e.action?.includes('run_right') || e.action?.includes('walk_right')) dx = 2;
                if (e.action?.includes('run_left') || e.action?.includes('walk_left')) dx = -2;
                if (e.action?.includes('jump')) dy = -10;
                
                return {
                    ...e,
                    dx: dx,
                    dy: dy,
                    groundY: e.y,
                    animFrame: 0 
                };
            });
        }

        function update() {
            currentScene.entities.forEach(e => {
                e.x += e.dx;
                e.y += e.dy;
                if (e.y < e.groundY) {
                    e.dy += 0.5;
                } else if (e.y > e.groundY) {
                    e.y = e.groundY;
                    e.dy = 0;
                }
                if (e.x > 800) e.x = -50;
                if (e.x < -50) e.x = 800;
                
                e.animFrame++;
            });
        }

        function draw() {
            ctx.clearRect(0, 0, 800, 600);

            // Background
            if (currentScene.background === 'park') ctx.fillStyle = '#90EE90';
            else if (currentScene.background === 'city') ctx.fillStyle = '#888';
            else if (currentScene.background === 'desert') ctx.fillStyle = '#F4A460';
            else ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, 800, 600);

            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.fillRect(0, 500, 800, 100);

            // Draw Sprites
            currentScene.entities.forEach(e => {
                const asset = ASSETS[e.type] || ASSETS['man'];
                const bounce = Math.abs(Math.sin(e.animFrame * 0.1)) * 5; 
                
                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.beginPath();
                ctx.ellipse(e.x + asset.width/2, e.groundY + asset.height, asset.width/2, 5, 0, 0, Math.PI*2);
                ctx.fill();

                // Draw Image from Canvas Buffer
                ctx.drawImage(asset.sprite, e.x, e.y - bounce, asset.width * 2, asset.height * 2);
            });
        }

        function loop() {
            update();
            draw();
            animationId = requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
